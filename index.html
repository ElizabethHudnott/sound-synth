<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<title>Web Audio Experiment</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="site.css">
	</head>
	<body>
		<div id="intro">
			<button onclick="initialize()">Initialize</button>
		</div>
		<div id="controls">
			<fieldset>
				<legend>Activation</legend>
				<button onclick="set(Synth.Param.GATE, Synth.Gate.TRIGGER)">Play Once</button>
				<button onclick="set(Synth.Param.GATE, channels[0].parameters[Synth.Param.GATE] !== Synth.Gate.OPEN? Synth.Gate.OPEN : Synth.Gate.CLOSED)">Sound On/Off</button>
				<br>
				<small>You can also play notes using the computer keyboard.</small><br>
				<input id="one-shot" type="checkbox" checked>One Shot
			</fieldset>
			<fieldset>
				<legend>Generation</legend>
				Oscillator:
				<input type="checkbox" oninput="set(Synth.Param.WAVEFORM, (channels[0].parameters[Synth.Param.WAVEFORM] & 11) + (this.checked? 4 : 0))">Pulse
				<input type="checkbox" oninput="set(Synth.Param.WAVEFORM, (channels[0].parameters[Synth.Param.WAVEFORM] & 13) + (this.checked? 2 : 0))">Sawtooth
				<input type="checkbox" oninput="set(Synth.Param.WAVEFORM, (channels[0].parameters[Synth.Param.WAVEFORM] & 14) + (this.checked? 1 : 0))" checked>Triangle
				<input type="checkbox" oninput="set(Synth.Param.WAVEFORM, (channels[0].parameters[Synth.Param.WAVEFORM] & 7) + (this.checked? 8 : 0))">Noise
				<br>
				Source:
				<input type="radio" name="source" oninput="set(Synth.Param.SOURCE, Synth.Source.OSCILLATOR)" checked>Oscillator
				<input id="samples" type="radio" name="source" oninput="set(Synth.Param.SOURCE, Synth.Source.SAMPLE)">Samples
				<br>
				Sample:
					<select oninput="set(Synth.Param.SAMPLE, parseInt(this.value))">
						<option value="0">Guitar</option>
						<option value="1">Violin</option>
					</select>
			</fieldset>
			<fieldset>
				<legend>LFO 1</legend>
				<input type="radio" name="lfo1-waveform" oninput="set(Synth.Param.LFO1_WAVEFORM, 'sine')" checked>Sine
				<input type="radio" name="lfo1-waveform" oninput="set(Synth.Param.LFO1_WAVEFORM, 'square')">Square
				<input type="radio" name="lfo1-waveform" oninput="set(Synth.Param.LFO1_WAVEFORM, 'sawtooth')">Sawtooth
				<input type="radio" name="lfo1-waveform" oninput="set(Synth.Param.LFO1_WAVEFORM, 'triangle')">Triangle
				<br>
				<input type="range" oninput="set(Synth.Param.LFO1_RATE, parseFloat(this.value))" min="0" max="20" value="5" step="0.1">Rate<br>
				<input type="range" oninput="set(Synth.Param.LFO1_DELAY, parseFloat(this.value))" min="0" max="1000" value="0" step="1">Delay<br>
				<input type="range" oninput="set(Synth.Param.LFO1_ATTACK, parseFloat(this.value))" min="0" max="1000" value="0" step="1">Attack<br>
				<input type="range" oninput="set(Synth.Param.LFO1_RATE_MOD, parseFloat(this.value))" min="0.05" max="1" value="1" step="0.01" class="flip-x">Rate Change<br>
			</fieldset>
			<fieldset>
				<legend>LFO 2</legend>
				<input type="radio" name="lfo2-waveform" oninput="set(Synth.Param.LFO2_WAVEFORM, 'sine')" checked>Sine
				<input type="radio" name="lfo2-waveform" oninput="set(Synth.Param.LFO2_WAVEFORM, 'square')">Square
				<input type="radio" name="lfo2-waveform" oninput="set(Synth.Param.LFO2_WAVEFORM, 'sawtooth')">Sawtooth
				<input type="radio" name="lfo2-waveform" oninput="set(Synth.Param.LFO2_WAVEFORM, 'triangle')">Triangle
				<br>
				<input type="range" oninput="set(Synth.Param.LFO2_RATE, parseFloat(this.value))" min="0" max="20" value="5" step="0.1">Rate<br>
				<input type="range" oninput="set(Synth.Param.LFO2_DELAY, parseFloat(this.value))" min="0" max="1000" value="0" step="1">Delay<br>
				<input type="range" oninput="set(Synth.Param.LFO2_ATTACK, parseFloat(this.value))" min="0" max="1000" value="0" step="1">Attack<br>
				<input type="range" oninput="set(Synth.Param.LFO2_RATE_MOD, parseFloat(this.value))" min="0.05" max="1" value="1" step="0.01" class="flip-x">Rate Change<br>
			</fieldset>
			<fieldset>
				<legend>Pulse Width Modulation</legend>
				Oscillator:
				<input type="radio" name="pwm-lfo" oninput="set(Synth.Param.PWM_LFO, 1)" checked>LFO 1
				<input type="radio" name="pwm-lfo" oninput="set(Synth.Param.PWM_LFO, 2)">LFO 2
				<br>
				<input type="range" oninput="set(Synth.Param.MIN_PULSE_WIDTH, parseFloat(this.value))" min="1" max="50" value="50" step="1">Min Pulse Width<br>
				<input type="range" oninput="set(Synth.Param.MAX_PULSE_WIDTH, parseFloat(this.value))" min="1" max="50" value="50" step="1">Max Pulse Width<br>
			</fieldset>
			<fieldset>
				<legend>Frequency</legend>
				<input id="frequency" type="range" oninput="set(Synth.Param.FREQUENCY, parseFloat(this.value))" min="80" max="8000" value="440" step="0.001">Frequency<br>
				<input id="note" type="range" oninput="playNote(Synth.Gate.TRIGGER)" min="21" max="108" value="69" step="1">Note<br>
				<input type="range" oninput="set(Synth.Param.DETUNE, parseFloat(this.value))" min="-99" max="99" value="0" step="0.001">Detune<br>
			</fieldset>
			<fieldset>
				<legend>Vibrato</legend>
				Oscillator:
				<input type="radio" name="vibrato-lfo" oninput="set(Synth.Param.VIBRATO_LFO, 1)">LFO 1
				<input type="radio" name="vibrato-lfo" oninput="set(Synth.Param.VIBRATO_LFO, 2)" checked>LFO 2
				<br>
				<input type="range" oninput="set(Synth.Param.VIBRATO_EXTENT, parseFloat(this.value))" min="0" max="200" value="0" step="1">Extent<br>
			</fieldset>
			<fieldset>
				<legend>Filter</legend>
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'lowpass')" checked>Low Pass
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'highpass')">High Pass
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'bandpass')">Band Pass
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'notch')">Notch
				<br>
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'allpass')">All Pass
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'lowshelf')">Low Shelf
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'highshelf')">High Shelf
				<input type="radio" name="filter-type" oninput="set(Synth.Param.FILTER_TYPE, 'peaking')">Peaking
				<br>
				<input type="range" oninput="set(Synth.Param.FILTERED_AMOUNT, parseFloat(this.value))" min="0" max="100" value="0" step="1">Amount<br>
				<input type="range" oninput="if (channels[0].parameters[Synth.Param.GATE] !== Synth.Gate.OPEN) { tempOpen = true; set(Synth.Param.GATE, Synth.Gate.OPEN);} set(Synth.Param.MIN_FILTER_FREQUENCY, parseFloat(this.value))" onmouseup="if (tempOpen) { set(Synth.Param.GATE, Synth.Gate.CLOSED); tempOpen = false;}" min="30" max="10000" value="4400" step="1">Min Frequency<br>
				<input type="range" oninput="if (channels[0].parameters[Synth.Param.GATE] !== Synth.Gate.OPEN) { tempOpen = true; set(Synth.Param.GATE, Synth.Gate.OPEN);} set(Synth.Param.MAX_FILTER_FREQUENCY, parseFloat(this.value))" onmouseup="if (tempOpen) { set(Synth.Param.GATE, Synth.Gate.CLOSED); tempOpen = false;}" min="30" max="10000" value="4400" step="1">Max Frequency<br>
				<input type="range" oninput="set(Synth.Param.FILTER_Q, parseFloat(this.value))" min="1" max="1000" value="1" step="1">Resonance / Width<br>
				<input type="radio" name="filter-lfo" oninput="set(Synth.Param.FILTER_LFO, 1)" checked>LFO 1
				<input type="radio" name="filter-lfo" oninput="set(Synth.Param.FILTER_LFO, 2)">LFO 2
				<br>
				<input type="range" oninput="set(Synth.Param.FILTER_GAIN, parseFloat(this.value))" min="-40" max="40" value="0" step="1">Gain<br>
			</fieldset>
			<fieldset>
				<legend>Tremolo</legend>
				Oscillator:
				<input type="radio" name="tremolo-lfo" oninput="set(Synth.Param.TREMOLO_LFO, 1)" checked>LFO 1
				<input type="radio" name="tremolo-lfo" oninput="set(Synth.Param.TREMOLO_LFO, 2)">LFO 2
				<br>
				<input type="range" oninput="set(Synth.Param.TREMOLO_DEPTH, parseFloat(this.value))" min="0" max="100" value="0" step="1">Depth<br>
			</fieldset>
			<fieldset>
				<legend>Amplitude Envelope</legend>
				<input type="range" oninput="set(Synth.Param.ATTACK, parseFloat(this.value))" min="0" max="500" value="2" step="1">Attack<br>
				<input type="range" oninput="set(Synth.Param.HOLD, parseFloat(this.value))" min="0" max="1000" value="0" step="1">Hold<br>
				<input type="range" oninput="set(Synth.Param.DECAY, parseFloat(this.value))" min="0" max="1000" value="50" step="1">Decay
				<input type="radio" name="decay-shape" oninput="set(Synth.Param.DECAY_SHAPE, Synth.ChangeType.LINEAR)" checked>Linear
				<input type="radio" name="decay-shape" oninput="set(Synth.Param.DECAY_SHAPE, Synth.ChangeType.EXPONENTIAL)">Exponential
				<br>
				<input type="range" oninput="set(Synth.Param.SUSTAIN, parseFloat(this.value))" min="0" max="100" value="75" step="1">Sustain<br>
				<input type="range" oninput="set(Synth.Param.RELEASE, parseFloat(this.value))" min="0" max="1000" value="300" step="1">Release
				<input type="radio" name="release-shape" oninput="set(Synth.Param.RELEASE_SHAPE, Synth.ChangeType.LINEAR)" checked>Linear
				<input type="radio" name="release-shape" oninput="set(Synth.Param.RELEASE_SHAPE, Synth.ChangeType.EXPONENTIAL)">Exponential
				<br>
				<input type="range" oninput="set(Synth.Param.DURATION, parseFloat(this.value))" min="0" max="4000" value="200" step="1">Default Duration<br>
			</fieldset>
			<fieldset>
				<legend>Sequencing</legend>
				<input id="line-time" type="range" oninput="setLineTime(parseInt(this.value))" min="15" max="150" value="50" step="1">Playing Time<br>
				<input id="ticks" type="range" oninput="calcTicks()" min="1" max="50" step="0.1" value="50">Ticks / second<br>
				1<input type="text" id="chord" oninput="playNote(Synth.Gate.TRIGGER)" size="6"> Broken Chord <small>(chromatic scale, e.g. 158)</small><br>
				<input type="range" oninput="set(Synth.Param.CHORD_SPEED, parseInt(this.value))" min="0" max="16" value="1" step="1">Chord rotation time<br>
				<input type="radio" name="chord-pattern" oninput="set(Synth.Param.CHORD_PATTERN, Synth.Pattern.CYCLE)">Cycle
				<input type="radio" name="chord-pattern" oninput="set(Synth.Param.CHORD_PATTERN, Synth.Pattern.TO_AND_FRO)">To and Fro
				<input type="radio" name="chord-pattern" oninput="set(Synth.Param.CHORD_PATTERN, Synth.Pattern.TO_AND_FRO_2)" checked>To and Fro 2
				<input type="radio" name="chord-pattern" oninput="set(Synth.Param.CHORD_PATTERN, Synth.Pattern.RANDOM)">Random
				<br>
				<input id="glissando" type="range" oninput="set(Synth.Param.GLISSANDO_SIZE, parseInt(this.value))" min="-12" max="12" value="0" step="1">Glissando
				<button type="button" onclick="document.getElementById('glissando').value = '0'; set(Synth.Param.GLISSANDO_SIZE, 0)">Reset</button>
				<br>
				<input type="range" oninput="set(Synth.Param.RETRIGGER, parseInt(this.value))" min="0" max="16" value="0" step="1">Retrigger Time<br>
			</fieldset>
			<fieldset>
				<legend>Output</legend>
				<input type="range" oninput="set(Synth.Param.VOLUME, parseFloat(this.value), 1, Synth.ChangeType.LINEAR)" min="0" max="100" value="100" step="1">Volume
				<input type="range" oninput="set(Synth.Param.PAN, parseFloat(this.value))" min="-100" max="100" value="0" step="1">Pan
			</fieldset>
			<div style="flex-grow: 1"></div>
		</div>

		<script src="synth.js"></script>
		<script>
			const audioContext = new AudioContext({sampleRate: 96000});
			const system = new Synth.System(audioContext);
			let stepNumber = 1;
			let tempOpen = false;
			let octaveOffset = 0;
			let channels, timer;

			function sampleLoaded(url, success, message) {
				if (success) {
					console.log('Loaded ' + url);
				} else {
					console.log('Failed to load ' + url + '. ' + message);
				}
			}

			function sendNewLine() {
				if (channels[0].parameters[Synth.Param.GATE] === Synth.Gate.OPEN) {
					const parameterMap = new Map();
					const when = stepNumber * channels[0].parameters[Synth.Param.LINE_TIME];
					channels[0].setParameters(parameterMap, when);
				}
				stepNumber++;
			}

			function initialize() {
				audioContext.resume();
				let channel1 = new Synth.SubtractiveSynthChannel(system, true);
				let channel2 = new Synth.SubtractiveSynthChannel(system, true);
				channel2.connect(channel1);
				channels = [channel1, channel2];

				system.start();
				set(Synth.Param.FILTERED_AMOUNT, 0);
				set(Synth.Param.LINE_TIME, 50, 0);
				timer = setInterval(sendNewLine, 1000);
				sendNewLine();
				system.loadSample(0, 'samples/guitar-strum.wav', sampleLoaded);
				system.sampledNote[0] = 55;
				system.loadSample(1, 'samples/violin.wav', sampleLoaded);
				system.sampledNote[1] = 46;
				document.getElementById('intro').style.display = 'none';
				document.getElementById('controls').style.display = 'flex';
			}

			function set(parameterNumber, value, delay, changeType, channelNumber) {
				let time;
				if (delay !== undefined) {
					system.begin();
					time = delay;
					stepNumber = 1;
				}
				if (changeType === undefined) {
					changeType = Synth.ChangeType.SET;
				}
				if (channelNumber === undefined) {
					channelNumber = 0;
				}
				const parameterMap = new Map();
				parameterMap.set(parameterNumber, new Synth.Change(changeType, value));
				channels[channelNumber].setParameters(parameterMap, time);
			}

			function mix(channelNumber, source, amount) {
				const levels = channels[channelNumber].parameters[Synth.Param.MIX].slice();
				levels.splice(source, 1, amount);
				set(Synth.Param.MIX, levels, 0, Synth.ChangeType.SET, channelNumber);
			}

			function playNote(gate) {
				const noteNumber = parseInt(document.getElementById('note').value);
				document.getElementById('frequency').value = channels[0].noteFrequencies[noteNumber];
				const notes = [noteNumber];
				const chord = document.getElementById('chord').value;
				for (let i = 0; i < chord.length; i++) {
					const interval = parseInt(chord[i], 36);
					notes.push(noteNumber + interval - 1);
				}
				const parameterMap = new Map();
				parameterMap.set(Synth.Param.NOTES, new Synth.Change(Synth.ChangeType.SET, notes));
				if (channels[0].parameters[Synth.Param.GATE] !== Synth.Gate.OPEN) {
					parameterMap.set(Synth.Param.GATE, new Synth.Change(Synth.ChangeType.SET, gate));
				}
				channels[0].setParameters(parameterMap);
			}

			function setLineTime(steps) {
				clearInterval(timer);
				set(Synth.Param.LINE_TIME, steps, 0);
				const ticksPerSecond = parseFloat(document.getElementById('ticks').value);
				const ticks = Math.round(steps / 50 * ticksPerSecond);
				set(Synth.Param.TICKS, ticks);
				timer = setInterval(sendNewLine, steps * 20);
				sendNewLine();
			}

			function calcTicks() {
				const lineTime = channels[0].parameters[Synth.Param.LINE_TIME];
				const ticksPerSecond = parseFloat(document.getElementById('ticks').value);
				const ticks = Math.round(lineTime / 50 * ticksPerSecond);
				set(Synth.Param.TICKS, ticks);
			}

			document.addEventListener('keydown', function (event) {
				if (event.repeat || event.shiftKey || event.altKey || event.ctrlKey ||
					document.activeElement.type === 'text'
				) {
					return;
				}

				const code = event.code;

				if (code === 'Quote') {
					set(Synth.Param.GATE, Synth.Gate.CUT);
					event.preventDefault();
				} else if (code === 'NumpadDivide') {
					octaveOffset--;
					if (octaveOffset < -3) {
						octaveOffset = -3;
					}
				} else if (code === 'NumpadMultiply') {
					octaveOffset++;
					if (octaveOffset > 4) {
						octaveOffset = 4;
					}
				} else {
					const note = Synth.keymap.get(code);
					if (note !== undefined) {
						document.getElementById('note').value = octaveOffset * 12 + note;
						const gate = document.getElementById('one-shot').checked || document.getElementById('samples').checked?
							Synth.Gate.TRIGGER : Synth.Gate.OPEN;
						playNote(gate);
						event.preventDefault();
					}
				}
			});

			document.addEventListener('keyup', function (event) {
				if (event.shiftKey || event.altKey || event.ctrlKey ||
					document.activeElement.type === 'text'
				) {
					return;
				}

				const note = Synth.keymap.get(event.code);
				if (note !== undefined) {
					if (!document.getElementById('one-shot').checked) {
						set(Synth.Param.GATE, Synth.Gate.CLOSED);
						event.preventDefault();
					}
				}
			});
		</script>
	</body>
</html>
