<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<title>Web Audio Experiment</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="site.css">
	</head>
	<body>
		<div id="intro">
			<button onclick="initialize()">Initialize</button>
		</div>
		<div id="controls">
			<fieldset>
				<legend>Activation</legend>
				<button onclick="set(Parameter.GATE, Gate.TRIGGER)">Play Once</button>
				<button onmousedown="set(Parameter.GATE, Gate.OPEN)" onmouseup="set(Parameter.GATE, Gate.CLOSED)">Play Held Down</button>
				<button onclick="set(Parameter.GATE, channel1.parameters[Parameter.GATE] !== Gate.OPEN? Gate.OPEN : Gate.CLOSED)">Sound On/Off</button>
				<button onclick="set(Parameter.GATE, Gate.RETRIGGER)">Retrigger</button>
				<button onclick="set(Parameter.GATE, Gate.CUT)">Cut</button>
			</fieldset>
			<fieldset>
				<legend>Generation</legend>
				<label><input type="radio" name="waveform" oninput="set(Parameter.WAVEFORM, 'sine')" checked>Sine</label>
				<label><input type="radio" name="waveform" oninput="set(Parameter.WAVEFORM, 'square')">Square</label>
				<label><input type="radio" name="waveform" oninput="set(Parameter.WAVEFORM, 'sawtooth')">Sawtooth</label>
				<label><input type="radio" name="waveform" oninput="set(Parameter.WAVEFORM, 'triangle')">Triangle</label><br>
				<input type="range" oninput="set(Parameter.PULSE_WIDTH, parseFloat(this.value))" min="1" max="50" value="50" step="1">Pulse Width
			</fieldset>
			<fieldset>
				<legend>Mixer</legend>
				<label><input type="checkbox" onclick="set(Parameter.VOICE, (channel1.parameters[Parameter.VOICE] & 14) + (this.checked? 1 : 0))" checked>Oscillator</label>
				<label><input type="checkbox" onclick="set(Parameter.VOICE, (channel1.parameters[Parameter.VOICE] & 13) + (this.checked? 2 : 0))">Pulse</label>
				<label><input type="checkbox" onclick="set(Parameter.VOICE, (channel1.parameters[Parameter.VOICE] & 11) + (this.checked? 4 : 0))">Noise</label><br/>
				<input type="range" oninput="mix(0, parseFloat(this.value))" min="0" max="100" step="1" value="100">Oscillator<br>
				<input type="range" oninput="mix(1, parseFloat(this.value))" min="0" max="100" step="1" value="100">Pulse<br>
				<input type="range" oninput="mix(2, parseFloat(this.value))" min="0" max="100" step="1" value="100">Noise<br>
			</fieldset>
			<fieldset>
				<legend>Amplitude Envelope</legend>
				<input type="range" oninput="set(Parameter.ATTACK, parseFloat(this.value))" min="0" max="1000" value="2" step="1">Attack<br>
				<input type="range" oninput="set(Parameter.DECAY, parseFloat(this.value))" min="0" max="1000" value="50" step="1">Decay<br>
				<input type="range" oninput="set(Parameter.SUSTAIN, parseFloat(this.value))" min="0" max="100" value="50" step="1">Sustain<br>
				<input type="range" oninput="set(Parameter.RELEASE, parseFloat(this.value))" min="0" max="1000" value="300" step="1">Release<br>
				<input type="range" oninput="set(Parameter.DURATION, parseFloat(this.value))" min="0" max="4000" value="200" step="1">Default Duration<br>
			</fieldset>
			<fieldset>
				<legend>Frequency</legend>
				<input id="frequency" type="range" oninput="set(Parameter.FREQUENCY, parseFloat(this.value))" min="80" max="13000" value="440" step="0.001">Frequency<br>
				<input type="range" oninput="document.getElementById('frequency').value = noteFrequencies[parseInt(this.value)]; set(Parameter.NOTE, parseInt(this.value)); if (channel1.parameters[Parameter.GATE] !== Gate.OPEN) set(Parameter.GATE, Gate.TRIGGER)" min="40" max="108" value="69" step="1">Note<br>
				<input type="range" oninput="set(Parameter.DETUNE, parseFloat(this.value))" min="-99" max="99" value="0" step="0.001">Detune<br>
			</fieldset>
			<fieldset>
				<legend>Vibrato</legend>
				<label><input type="radio" name="vibrato-waveform" oninput="set(Parameter.VIBRATO_WAVEFORM, 'sine')" checked>Sine</label>
				<label><input type="radio" name="vibrato-waveform" oninput="set(Parameter.VIBRATO_WAVEFORM, 'square')">Square</label>
				<label><input type="radio" name="vibrato-waveform" oninput="set(Parameter.VIBRATO_WAVEFORM, 'sawtooth')">Sawtooth</label>
				<label><input type="radio" name="vibrato-waveform" oninput="set(Parameter.VIBRATO_WAVEFORM, 'triangle')">Triangle</label><br>
				<input type="range" oninput="set(Parameter.VIBRATO_RATE, parseFloat(this.value))" min="0" max="25" value="5" step="0.1">Rate<br>
				<input type="range" oninput="set(Parameter.VIBRATO_EXTENT, parseFloat(this.value))" min="0" max="200" value="0" step="1">Extent<br>
			</fieldset>
			<fieldset>
				<legend>Filter</legend>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'lowpass')" checked>Low Pass</label>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'highpass')">High Pass</label>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'bandpass')">Band Pass</label>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'notch')">Notch</label><br>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'allpass')">All Pass</label>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'lowshelf')">Low Shelf</label>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'highshelf')">High Shelf</label>
				<label><input type="radio" name="filter-type" oninput="set(Parameter.FILTER_TYPE, 'peaking')">Peaking</label><br>
				<input type="range" oninput="set(Parameter.FILTERED_AMOUNT, parseFloat(this.value))" min="0" max="100" value="0" step="1">Amount<br>
				<input type="range" oninput="set(Parameter.FILTER_FREQUENCY, parseFloat(this.value))" min="30" max="10000" value="4400" step="1">Frequency<br>
				<input type="range" oninput="set(Parameter.FILTER_Q, parseFloat(this.value))" min="0.0001" max="300" value="1" step="0.001">Q<br>
				<input type="range" oninput="set(Parameter.FILTER_GAIN, parseFloat(this.value))" min="-40" max="40" value="0" step="1">Gain<br>
			</fieldset>
			<fieldset>
				<legend>Tremolo</legend>
				<label><input type="radio" name="tremolo-waveform" oninput="set(Parameter.TREMOLO_WAVEFORM, 'sine')" checked>Sine</label>
				<label><input type="radio" name="tremolo-waveform" oninput="set(Parameter.TREMOLO_WAVEFORM, 'square')">Square</label>
				<label><input type="radio" name="tremolo-waveform" oninput="set(Parameter.TREMOLO_WAVEFORM, 'sawtooth')">Sawtooth</label>
				<label><input type="radio" name="tremolo-waveform" oninput="set(Parameter.TREMOLO_WAVEFORM, 'triangle')">Triangle</label><br>
				<input type="range" oninput="set(Parameter.TREMOLO_FREQUENCY, parseFloat(this.value))" min="0" max="25" value="5" step="0.1">Frequency<br>
				<input type="range" oninput="set(Parameter.TREMOLO_AMOUNT, parseFloat(this.value))" min="0" max="100" value="0" step="1">Amount<br>
			</fieldset>
			<div>
				<input type="range" oninput="set(Parameter.VOLUME, parseFloat(this.value), ChangeType.LINEAR, 1)" min="0" max="100" value="100" step="1">Volume
				<label><input type="checkbox" onclick="set(Parameter.PANNED, this.checked? 1 : 0)">Pan Left</label>
			</div>
		</div>

		<script src="synth.js"></script>
		<script>
			let system, channel1;

			function initialize() {
				audioContext.resume();
				system = new SynthSystem(audioContext);
				channel1 = new SubtractiveSynthChannel(system, true);
				system.start();
				set(Parameter.FILTERED_AMOUNT, 0);
				document.getElementById('intro').style.display = 'none';
				document.getElementById('controls').style.display = 'block';
			}

			function set(parameterNumber, value, delay, changeType) {
				if (delay === undefined) {
					delay = 0;
				}
				if (changeType === undefined) {
					changeType = ChangeType.SET;
				}
				const parameterMap = new Map();
				parameterMap.set(parameterNumber, new Change(changeType, value));
				system.begin();
				channel1.setParameters(parameterMap, delay);
			}

			function mix(source, amount) {
				const levels = channel1.parameters[Parameter.MIX].slice();
				levels.splice(source, 1, amount);
				set(Parameter.MIX, levels);
			}
		</script>
	</body>
</html>
